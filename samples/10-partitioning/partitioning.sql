SET NOCOUNT ON
GO

SELECT * FROM sys.[external_data_sources]
SELECT * FROM sys.[database_scoped_credentials]
GO

DROP TABLE IF EXISTS [test].[ORDERS];
CREATE TABLE [test].[ORDERS]
(
	[O_ORDERKEY] [INT] NOT NULL,
	[O_CUSTKEY] [INT] NOT NULL,
	[O_ORDERSTATUS] [CHAR](1) NOT NULL,
	[O_TOTALPRICE] [DECIMAL](15, 2) NOT NULL,
	[O_ORDERDATE] [DATE] NOT NULL,
	[O_ORDERPRIORITY] [CHAR](15) NOT NULL,
	[O_CLERK] [CHAR](15) NOT NULL,
	[O_SHIPPRIORITY] [INT] NOT NULL,
	[O_COMMENT] [VARCHAR](79) NOT NULL,
	[O_ORDERYEAR]  AS (DATEPART(YEAR,[O_ORDERDATE])) PERSISTED,
	[O_ORDERMONTH]  AS (DATEPART(MONTH,[O_ORDERDATE]))
)

DROP EXTERNAL DATA SOURCE [Azure-Storage];
DROP DATABASE SCOPED CREDENTIAL [Storage-Credentials];
GO

CREATE DATABASE SCOPED CREDENTIAL [Storage-Credentials]
WITH IDENTITY = 'SHARED ACCESS SIGNATURE',
SECRET = ''; -- Remove starting question mark
GO

CREATE EXTERNAL DATA SOURCE [Azure-Storage]
WITH 
( 
	TYPE = BLOB_STORAGE,
 	LOCATION = 'https://myaccount.blob.core.windows.net',
 	CREDENTIAL= [Storage-Credentials]
);

BULK INSERT [test].[ORDERS]
FROM 'tpch/1GB/orders.tbl'
WITH
(
	DATA_SOURCE = 'Azure-Storage',
	FIELDTERMINATOR = '|',
	BATCHSIZE=10000
)
GO

SELECT DISTINCT DATEFROMPARTS(YEAR(O_ORDERDATE),1,1) FROM [test].[ORDERS] ORDER BY 1
GO

CREATE PARTITION FUNCTION pf_OrderDate(DATE)
AS RANGE RIGHT FOR VALUES 
('1992-01-01', '1993-01-01', '1994-01-01', '1995-01-01', '1996-01-01', '1997-01-01', '1998-01-01')
GO

CREATE PARTITION SCHEME ps_OrderDate 
AS PARTITION pf_OrderDate
ALL TO ([Primary])
GO

CREATE CLUSTERED INDEX IXC ON [test].[ORDERS] (O_ORDERKEY, O_ORDERDATE) 
WITH DROP_EXISTING 
ON ps_OrderDate(O_ORDERDATE) 
GO

SELECT * FROM [test].[ORDERS] WHERE O_ORDERDATE = '1995-02-07'
GO

SELECT $partition.pf_OrderDate('1992-01-01')
GO

TRUNCATE TABLE [test].[ORDERS] WITH (PARTITIONS (2)) 
GO

SELECT * FROM [test].[ORDERS] WHERE O_ORDERDATE = '1992-01-07'
GO

